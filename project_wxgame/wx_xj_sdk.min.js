!function(){const hostUrl='https://api.xiaozigame.com/api';var netWatching=false;var netIsConnected=true;var noNetRequestList=[];class noNetRequestItem{constructor(url,params){this.url=url;this.params=params;this.request=this.request.bind(this)}request(){statRequest(this.url,this.params);noNetRequestList.splice(noNetRequestList.indexOf(this),1)}}function watchNetChange(){if(netWatching){return}netWatching=true;wx.getNetworkType({success(res){res.networkType=='none'&&(netIsConnected=false)}});wx.onNetworkStatusChange((res)=>{netIsConnected=res.isConnected?true:false;res.isConnected&&noNetRequestList.length>0&&againRequest()});function againRequest(){let t=0;noNetRequestList.forEach(ele=>{setTimeout(ele.request,t+=100)});t=0}}function getCode(){return new Promise((resolve,reject)=>{wx.login({success(res){resolve(res.code)},fail(){console.log('获取code失败，请重新获取')}})})}function init(appKey='',openid='',options={},fn){var version = 1 ;watchNetChange();if(!appKey){console.log('请传入正确的appKey');return new Promise((resolve,reject)=>{resolve('请传入正确的appKey')})}wx.setStorageSync('count_appkey',appKey);if(openid){wx.setStorageSync('count_openid',openid)}else{openid=wx.getStorageSync('count_openid')||''}options.query=options.query||{};let channel="";if(options.ch){channel=options.ch}else if(options.query.ch){channel=options.query.ch}else if(options.query.scene){channel=decodeURIComponent(options.query.scene)}wx.setStorageSync('count_ch',channel);let scene=options.scene||'1001';let optStr=JSON.stringify(options)||'';let params={code:'',channel:channel,scene:scene,appKey:appKey,openid:openid,options:optStr,version,fn};if(openid){return reportInit(params)}else{return getCode().then(code=>{params.code=code;return reportInit(params)})}}function reportInit(params){var{fn}=params;delete params.fn;return statRequest('/openid',params).then(res=>{if(res&&res.data.code==200){wx.setStorageSync('count_openid',res.data.openid);if(wx.getStorageSync('load_event')){load()}if(fn)fn(res.data);return res}else if(res===false){}else{console.log(res.data.message,'上报初始化错误1');return res}}).catch((err)=>{console.log(err)})}function reportInitCallBack(params,resData){}var eventName,subEventName;function reportCustomEvent(params={}){params.appKey=wx.getStorageSync('count_appkey')||'';params.openid=wx.getStorageSync('count_openid')||'';params.channel=wx.getStorageSync('count_ch')||'';params.eventName=params.eventName||'';params.subEventName=params.subEventName||'';eventName=params.eventName;subEventName=params.subEventName;if(params.openid&&params.appKey){return doReportCustomEvent(params)}else{console.log('自定义缺参数');return}}function doReportCustomEvent(params){if(!params.eventName){console.log('reportCustomEvent errMsg: 参数错误');return'err'}return statRequest('/event',params).then(res=>{if(res&&res.data.code==200){return res}else if(res===false){}else{console.log(res.data.message,'自定义事件错误1');return res}}).catch((err)=>{console.log('上报自定义事件失败2');console.log(err)})}function reportCustomEvent_a(params={}){params.appKey=wx.getStorageSync('count_appkey')||'';params.openid=wx.getStorageSync('count_openid')||'';params.channel=wx.getStorageSync('count_ch')||'';params.eventName=params.eventName||'';params.subEventName=params.subEventName||'';eventName=params.eventName;subEventName=params.subEventName;if(params.openid&&params.appKey){return doReportCustomEvent_a(params)}else{console.log('自定义缺参数_a');return}}function doReportCustomEvent_a(params){if(!params.eventName){console.log('reportCustomEvent_a errMsg: 参数错误');return'err'}return statRequest('/event_a',params).then(res=>{if(res&&res.data.code==200){return res}else if(res===false){}else{console.log(res.data.message,'自定义事件错误_a1');return res}}).catch((err)=>{console.log('上报自定义事件失败_a2');console.log(err)})}function login(params={}){params.appKey=wx.getStorageSync('count_appkey')||'';params.openid=wx.getStorageSync('count_openid')||'';params.channel=wx.getStorageSync('count_ch')||'';if(!params.appKey||!params.openid){console.log('授权缺参数');return'err'}return statRequest('/login',params).then(res=>{if(res&&res.data.code==200){return res}else if(res===false){}else{console.log(res.data.message,'首次授权错误1');return res}}).catch((err)=>{console.log('首次授权上报错误2');console.log(err)})}function load(params={}){params.appKey=wx.getStorageSync('count_appkey')||'';params.openid=wx.getStorageSync('count_openid')||'';params.channel=wx.getStorageSync('count_ch')||'';if(!params.appKey||!params.openid){wx.setStorageSync("load_event",true);console.log('首次加载缺参数');return'err'}return statRequest('/load',params).then(res=>{if(res&&res.data.code==200){return res}else if(res===false){}else{console.log(res.data.message,'首次加载错误1');return res}}).catch((err)=>{console.log('首次加载上报错误2');console.log(err)})}function role(params={}){params.appKey=wx.getStorageSync('count_appkey')||'';params.openid=wx.getStorageSync('count_openid')||'';params.channel=wx.getStorageSync('count_ch')||'';if(!params.appKey||!params.openid){console.log('首次创角缺参数');return'err'}return statRequest('/role',params).then(res=>{if(res&&res.data.code==200){return res}else if(res===false){}else{console.log(res.data.message,'首次创角错误1');return res}}).catch((err)=>{console.log('首次创角上报错误2');console.log(err)})}function exposureMiniProgram(val){val=val.join(',');let params={eventName:'exposureMiniProgram_a',subEventName:val};reportCustomEvent_a(params)}function clickMiniProgram(url){let params={eventName:'clickMiniProgram',subEventName:url};reportCustomEvent(params)}function navigateToMiniProgram(url){let params={eventName:'navigateToMiniProgram',subEventName:url};reportCustomEvent(params)}let UserPaySay=true;function gameUserPay(openid,out_trade_no,total_fee,goods_id,goods_name,notify_url,extra){let url='https://api.xiaozigame.com/pay/create';if(UserPaySay){UserPaySay=false;wx.request({url:`${url}?openid=${openid}&out_trade_no=${out_trade_no}&total_fee=${total_fee}&goods_id=${goods_id}&goods_name=${goods_name}&notify_url=${notify_url}&extra=${extra}`,success(data){UserPaySay=true;return data},fail(data){UserPaySay=true;return data}})}}function getGuide(version,fn){var options=wx.getLaunchOptionsSync();options.query=options.query||{};let channel="";if(options.ch){channel=options.ch}else if(options.query.ch){channel=options.query.ch}else if(options.query.scene){channel=decodeURIComponent(options.query.scene)}wx.setStorageSync('count_ch',channel);let params={version,channel};let reg=/^[1-9]\d*$/;if(reg.test(params.version)){wx.request({url:"https://api.xiaozigame.com/guide/data",data:params,success(res){fn&&fn(res.data)},fail(res){console.log("guide请求报错",res)}})}else{console.log("guide版本号填写错误")}}function reportFailDeal(reportEventName='',params={}){if(!reportEventName){return'err'}if(getrep('rep_'+reportEventName)){return}setTimeout(()=>{if(reportEventName=='/openid'){reportInit(params)}if(reportEventName=='/event'){;reportCustomEvent(params)}if(reportEventName=='/load'){load(params)}if(reportEventName=='/login'){login(params)}if(reportEventName=='/role'){role(params)}},5000);function getrep(val){var rep=wx.getStorageSync(val);if(rep){wx.setStorageSync(val,rep+1)}else{wx.setStorageSync(val,1)}if(rep>=8){setTimeout(()=>{wx.setStorageSync(val,0)},60000);return true}else{return false}}}class peel{constructor(fleld){this.val=fleld;this.set=function(val){wx.setStorageSync(`diy_event_${val.val}`,`${val.val}`)};this.get=(val)=>{let fleld=wx.getStorageSync(`diy_event_${val.val}`);if(fleld===val.val){return 1}else{return 0}};this.ret=()=>{let then={};then.then=function(val){val(false);let then={};then.catch=function(val){};return then};return then};this.end=(val)=>{wx.removeStorageSync(`diy_event_${val.val}`)}}}function statRequest(url,data){if(!url){return'err'}return new Promise((resolve,reject)=>{wx.request({url:hostUrl+url,method:'POST',data:data,header:{'content-type':'application/x-www-form-urlencoded'},success:resolve,fail(res){wx.getNetworkType({success(res){if(res.networkType=='none'){noNetRequestList.push(new noNetRequestItem(url,data))}else{reportFailDeal(url,data)}}});reject(res)},complete(){}})}).catch(err=>{console.log(err)})}module.exports={init,reportCustomEvent,load,login,role,exposureMiniProgram,clickMiniProgram,navigateToMiniProgram,gameUserPay,getGuide}}();